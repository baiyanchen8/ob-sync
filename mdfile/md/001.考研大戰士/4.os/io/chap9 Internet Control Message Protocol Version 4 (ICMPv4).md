# Introduction
![[Pasted image 20250603102729.png]]
> [!bug] IP provides unreliable services
> - drawsback
> 	- ç¼ºä¹éŒ¯èª¤æ§åˆ¶æ©Ÿåˆ¶ 
> 	- ç¼ºä¹å”åŠ©æ©Ÿåˆ¶
> - solution : ICMP
> 	- A network layer protocol
> 	- However, its message are not passed directly to the data link layer
> 	- The message are first encapsulated inside IP datagram
> 	- è©²è¨Šæ¯é¦–å…ˆå°è£åœ¨ IP è³‡æ–™å°åŒ…ä¸­

![[Pasted image 20250603104541.png]]

# Message
- ICMP messages are divided into
	- Error-reporting message
		- Report problems that a router or a host (destination) may encounter
	- Query message
		- To get specific information
![[Pasted image 20250603105510.png]]

![[Pasted image 20250603105850.png]]

![[Pasted image 20250603105855.png]]

| æ¬„ä½åç¨±               | é•·åº¦      | èªªæ˜                                                                           |
| ------------------ | ------- | ---------------------------------------------------------------------------- |
| **Type**           | 1 byte  | æŒ‡å®šæ˜¯å“ªç¨® ICMP è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šType 8 è¡¨ç¤º Echo Requestï¼‰                                     |
| **Code**           | 1 byte  | æŒ‡å®šé€™ç¨®é¡å‹ä¸‹çš„æ›´ç´°éƒ¨åŸå› ï¼ˆä¾‹å¦‚ï¼šType 3 æ˜¯ Destination Unreachableï¼ŒCode 0 è¡¨ç¤º Net unreachableï¼‰ |
| **Checksum**       | 2 bytes | ç”¨ä¾†æª¢æŸ¥ ICMP è¨Šæ¯æ˜¯å¦æå£                                                             |
| **Rest of Header** | 4 bytes | è¦–è¨Šæ¯ç¨®é¡è€Œå®šï¼Œæœƒæœ‰ä¸åŒç”¨é€”ï¼Œä¾‹å¦‚è­˜åˆ¥ç¢¼èˆ‡åºè™Ÿï¼ˆping ç”¨ï¼‰ã€å°åŒ…è³‡è¨Šï¼ˆéŒ¯èª¤ç”¨ï¼‰ç­‰                                   |
## Error Reporting Messages
- ICMP only report error
	- Does not correct error
	- Error correction is left to the higher-level protocol

> [!question] Question: å°åŒ…åœ¨å‚³é€ä¸­å‡ºéŒ¯äº†(ä¾‹å¦‚Routerä¸Ÿæ£„ ), èª°ç”¢ç”ŸICMPçš„Message?é€çµ¦èª°å‘¢?
>  -  å°‡å°åŒ…ä¸Ÿæ£„çš„Routeræˆ–æ˜¯Hostç”¢ç”Ÿ,
>  - é€çµ¦åŸæœ¬çš„Source

>[!question] Question: ä½ è¦ºå¾—éœ€è¦é‚£äº›Error-reporting messages?
>![[Pasted image 20250603111917.png]]


### Destination Unreachable(type3)
- ç•¶è·¯ç”±å™¨ç„¡æ³•è·¯ç”±è³‡æ–™å°åŒ…æˆ–ç›®æ¨™ä¸»æ©Ÿç„¡æ³•éé€è³‡æ–™å°åŒ…æ™‚
	- ä¸Ÿæ£„æ•¸æ“šå ±Destination Unreachable
	- è·¯ç”±å™¨æˆ–ä¸»æ©Ÿå°‡ç›®æ¨™ä¸å¯é”è¨Šæ¯å‚³é€å›ä¾†æºä¸»æ©Ÿ

| Code | æ„ç¾©                                                           | åŸå› /æƒ…æ³                           | ç”±èª°ç”¢ç”Ÿ  |
| ---- | ------------------------------------------------------------ | ------------------------------- | ----- |
| 0    | **ç¶²è·¯ç„¡æ³•æŠµé”ï¼ˆNetwork unreachableï¼‰**                              | ç¶²è·¯å­˜åœ¨ä½†æš«æ™‚ç„¡æ³•åˆ°é”ï¼ˆå¯èƒ½æ˜¯ç¡¬é«”æ•…éšœï¼‰            | è·¯ç”±å™¨   |
| 1    | **ä¸»æ©Ÿç„¡æ³•æŠµé”ï¼ˆHost unreachableï¼‰**                                 | ä¸»æ©Ÿå­˜åœ¨ä½†æš«æ™‚ç„¡æ³•é€£ç·šï¼ˆå¯èƒ½æ˜¯ç¶²å¡å£äº†ï¼‰            | è·¯ç”±å™¨   |
| 2    | **å”å®šç„¡æ³•æŠµé”ï¼ˆProtocol unreachableï¼‰**                             | å‚³é€åˆ°ç›®çš„ä¸»æ©Ÿå¾Œï¼Œä¸Šå±¤å”å®šï¼ˆå¦‚ TCP/UDPï¼‰ç„¡æ³•è™•ç†    | ç›®çš„åœ°ä¸»æ©Ÿ |
| 3    | **é€£æ¥åŸ ç„¡æ³•æŠµé”ï¼ˆPort unreachableï¼‰**                                | è©² port æ²’æœ‰æ‡‰ç”¨ç¨‹å¼åœ¨è½                 | ç›®çš„åœ°ä¸»æ©Ÿ |
| 4    | **éœ€è¦åˆ†æ®µä½†è¨­å®šç‚ºä¸å¯åˆ†æ®µï¼ˆDF bit setï¼‰**                                 | é€å‡ºçš„å°åŒ…å¤ªå¤§ã€éœ€è¦åˆ†æ®µï¼Œä½† DF bit è¢«è¨­å®šï¼ˆä¸å¯åˆ†æ®µï¼‰ | è·¯ç”±å™¨   |
| 5    | **ä¾†æºè·¯ç”±ç„¡æ³•å®Œæˆï¼ˆSource route failedï¼‰**                            | source routing ä¸­æŸå€‹è·¯ç”±å™¨ç„¡æ³•æ‹œè¨ª       | è·¯ç”±å™¨   |
| 6    | **ç›®çš„ç¶²è·¯æœªçŸ¥ï¼ˆDestination network unknownï¼‰**                      | è·¯ç”±å™¨**ä¸çŸ¥é“é€™å€‹ç¶²è·¯**åœ¨å“ª                | è·¯ç”±å™¨   |
| 7    | **ç›®çš„ä¸»æ©ŸæœªçŸ¥ï¼ˆDestination host unknownï¼‰**                         | è·¯ç”±å™¨**ä¸çŸ¥é“æœ‰é€™å°ä¸»æ©Ÿ**                 | è·¯ç”±å™¨   |
| 8    | **ä¾†æºä¸»æ©Ÿè¢«éš”é›¢ï¼ˆSource host isolatedï¼‰**                            | ä¾†æºä¸»æ©Ÿå¯èƒ½è¢«éš”é›¢åœ¨æŸæ®µå°é–‰ç¶²è·¯ä¸­               | è·¯ç”±å™¨   |
| 9    | **ç›®çš„ç¶²è·¯é€šè¨Šè¢«ç®¡ç†å“¡å°é–ï¼ˆNetwork administratively prohibitedï¼‰**        | ç®¡ç†å“¡è¨­çš„ ACL æˆ–é˜²ç«ç‰†è¦å‰‡é˜»æ“‹äº†é€£ç·š           | è·¯ç”±å™¨   |
| 10   | **ç›®çš„ä¸»æ©Ÿé€šè¨Šè¢«ç®¡ç†å“¡å°é–ï¼ˆHost administratively prohibitedï¼‰**           | åŒä¸Šï¼Œåªæ˜¯é‡å°ä¸»æ©Ÿå±¤ç´š                     | è·¯ç”±å™¨   |
| 11   | **ç‰¹å®šæœå‹™é¡å‹çš„ç¶²è·¯ç„¡æ³•æŠµé”ï¼ˆNetwork unreachable for ToSï¼‰**               | æŸç¨®æœå‹™å“è³ªï¼ˆQoSï¼‰ä¸‹ï¼Œç¶²è·¯ä¸å¯é”              | è·¯ç”±å™¨   |
| 12   | **ç‰¹å®šæœå‹™é¡å‹çš„ä¸»æ©Ÿç„¡æ³•æŠµé”ï¼ˆHost unreachable for ToSï¼‰**                  | åŒä¸Šï¼Œåªæ˜¯é‡å°ä¸»æ©Ÿ                       | è·¯ç”±å™¨   |
| 13   | **ä¸»æ©Ÿè¢«ç®¡ç†å“¡è¨­éæ¿¾è¦å‰‡è€Œä¸å¯é”ï¼ˆCommunication administratively filteredï¼‰** | é€šå¸¸æ˜¯é˜²ç«ç‰†è¨­å®šæ“‹æ‰çš„                     | è·¯ç”±å™¨   |
| 14   | **ä¸»æ©Ÿå„ªå…ˆæ¬Šè¢«æ‹’çµ•ï¼ˆHost precedence violationï¼‰**                      | å°åŒ…è¦æ±‚å¤ªé«˜çš„å„ªå…ˆæ¬Šï¼Œå°æ–¹ä¸æ¥å—                | è·¯ç”±å™¨   |
| 15   | **ä¸»æ©Ÿå„ªå…ˆæ¬Šè¢«ä¸­æ­¢ï¼ˆPrecedence cutoff in effectï¼‰**                    | å°æ–¹è¨­å®šä¸æ¥å—ä½å„ªå…ˆæ¬Šçš„é€£ç·š                  | è·¯ç”±å™¨   |

>[!bug] â—ï¸æ²’æœ‰æ”¶åˆ° ICMPã€Œç›®çš„åœ°ç„¡æ³•æŠµé”ã€è¨Šæ¯ â‰  å°åŒ…é€é”æˆåŠŸ
>ğŸ“Œ é‡é»èªªæ˜ï¼š
>1. **ICMP æ˜¯ä¸€ç¨®éŒ¯èª¤å›å ±æ©Ÿåˆ¶ï¼Œä¸æ˜¯ç¢ºèªæ©Ÿåˆ¶**
> - å®ƒåªåœ¨ç™¼ç¾æ˜ç¢ºéŒ¯èª¤æ™‚æ‰æœƒé€å›å ±
> - å¦‚æœå°åŒ…ã€Œéœæ‚„æ‚„åœ°ã€æ‰äº†ã€æˆ–è¢«ä¸­é€”ä¸Ÿæ£„ï¼Œå¯èƒ½æ ¹æœ¬ä¸æœƒæœ‰ ICMP è¨Šæ¯ç”¢ç”Ÿ
>2. **å³ä½¿æ²’æœ‰æ”¶åˆ° ICMP éŒ¯èª¤ï¼Œä¹Ÿä¸èƒ½ä¿è­‰è³‡æ–™çœŸçš„æœ‰é€é”**
> - è³‡æ–™å¯èƒ½é‚„æ˜¯åœ¨é€”ä¸­è¢«ä¸Ÿæ‰ï¼ˆä¾‹å¦‚è¢«è·¯ç”±å™¨ä¸ŸåŒ…ï¼‰
> - ä¹Ÿå¯èƒ½è¢«é˜²ç«ç‰†æ“‹æ‰ï¼Œä½†æ²’ç”¢ç”Ÿä»»ä½•å›æ‡‰
### Time Exceeded: Two Situations (type 11)
- the packet stock in loop or circle 
	- cause by error in routing table 
	- ttl(time to live ) cut down to zero
	- è·¯ç”±å™¨ä¸Ÿæ£„è³‡æ–™å°åŒ…ä¸¦ç™¼é€é€¾æ™‚è¨Šæ¯
- ç•¶çµ„æˆä¸€å‰‡è¨Šæ¯çš„æ‰€æœ‰åˆ†ç‰‡æœªåœ¨ç‰¹å®šæ™‚é™å…§åˆ°é”ç›®çš„åœ°æ™‚
	- ç•¶ç¬¬ä¸€å€‹è³‡æ–™å°åŒ…åˆ°é”ç›®çš„åœ°æ™‚ï¼Œå®ƒæœƒå•Ÿå‹•è¨ˆæ™‚å™¨
	- ç•¶è¨ˆæ™‚å™¨åˆ°æœŸä¸”æ‰€æœ‰åˆ†ç‰‡å‡æœªåˆ°é”æ™‚
	- ç›®çš„åœ°æœƒä¸Ÿæ£„æ‰€æœ‰åˆ†ç‰‡ï¼Œä¸¦ç™¼é€è¶…æ™‚è¨Šæ¯
#### ICMPã€Œæ™‚é–“è¶…éï¼ˆTime Exceededï¼‰ã€è¨Šæ¯é¡å‹èªªæ˜ï¼š

- **Code 0**ï¼šTTLï¼ˆTime To Liveï¼‰ç‚º 0  
    ã€€â†’ å°åŒ…åœ¨ç¶²è·¯ä¸­å‚³éå¤ªä¹…ï¼ŒTTL æ•¸å€¼æ­¸é›¶ï¼ˆä¾‹å¦‚å°åŒ…é™·å…¥è·¯ç”±è¿´åœˆï¼‰  
    ã€€â†’ è·¯ç”±å™¨ä¸Ÿæ£„å°åŒ…ä¸¦å›å ±æ­¤éŒ¯èª¤
    
- **Code 1**ï¼šç¢ç‰‡é‡çµ„è¶…æ™‚  
    ã€€â†’ çµ„æˆå®Œæ•´è¨Šæ¯çš„å°åŒ…ç¢ç‰‡æ²’æœ‰åœ¨æ™‚é–“é™åˆ¶å…§å…¨éƒ¨æŠµé”ç›®çš„åœ°  
    ã€€â†’ ç›®çš„ç«¯ä¸Ÿæ£„æ‰€æœ‰å·²æ”¶åˆ°çš„ç¢ç‰‡ä¸¦å›å ±æ­¤éŒ¯èª¤
### Parameter Problem
- **ç•¶è·¯ç”±å™¨æˆ–ç›®çš„ç«¯åœ¨è™•ç†å°åŒ…æ™‚ï¼Œç™¼ç¾æŸå€‹æ¬„ä½çš„å€¼ä¸æ¸…æ¥šæˆ–ç¼ºæ¼ï¼Œå°±æœƒç™¼ç”Ÿé€™ç¨®éŒ¯èª¤**
- æ›å¥è©±èªªï¼Œ**å°åŒ…çš„æŸå€‹æ¬„ä½å€¼æœ‰å•é¡Œï¼ˆä¾‹å¦‚æ ¼å¼éŒ¯èª¤ã€æ¬„ä½éºå¤±æˆ–ç„¡æ³•è¾¨è­˜ï¼‰**
- é€™æ™‚ï¼Œæ¥æ”¶ç«¯æœƒä¸Ÿæ£„è©²å°åŒ…ï¼Œä¸¦å›å‚³ä¸€å€‹ **ICMPã€Œåƒæ•¸å•é¡Œï¼ˆParameter Problemï¼‰ã€** çš„éŒ¯èª¤è¨Šæ¯çµ¦ä¾†æºç«¯

> [!example]-
> é€™é¡Œæ˜¯åœ¨å•ï¼šç‚ºä»€éº¼ç•¶ç›®çš„ç«¯æ”¶åˆ°ä¸€å€‹ IP å°åŒ…ï¼Œé–‹é ­çš„å‰ 8 å€‹ bits æ˜¯ `01000010` æ™‚ï¼Œæœƒä¸Ÿæ£„è©²å°åŒ…ï¼Œä¸¦å‚³é€ ICMP çš„ã€Œåƒæ•¸å•é¡Œï¼ˆParameter Problemï¼‰ã€éŒ¯èª¤è¨Šæ¯çµ¦ä¾†æºç«¯ï¼Ÿ
>
>IP å°åŒ…çš„**å‰ 8 å€‹ä½å…ƒ**å°æ‡‰çš„æ˜¯ç¬¬ä¸€å€‹ä½å…ƒçµ„ï¼ˆByteï¼‰ï¼Œå…¶ä¸­å‰ 4 å€‹ bits æ˜¯ **IP ç‰ˆæœ¬è™Ÿï¼ˆVersionï¼‰**ï¼Œæ¥ä¸‹ä¾† 4 å€‹ bits æ˜¯ **IHLï¼ˆHeader Lengthï¼Œæ¨™é ­é•·åº¦ï¼‰**ã€‚
>#### åˆ†æ `01000010`
>- **å‰ 4 bitsï¼š`0100` â†’ åé€²ä½ 4** â†’ è¡¨ç¤º IP ç‰ˆæœ¬æ˜¯ IPv4 âœ…
>- **å¾Œ 4 bitsï¼š`0010` â†’ åé€²ä½ 2** â†’ è¡¨ç¤º IHL = 2 âŒ
>---
>
>#### ğŸ§  ç‚ºä»€éº¼é€™æ˜¯éŒ¯çš„ï¼Ÿ
>
>IHLï¼ˆIP Header Lengthï¼‰æ˜¯æŒ‡ **IP æ¨™é ­çš„é•·åº¦**ï¼Œå–®ä½æ˜¯ã€Œ4-byte wordsã€ï¼ˆå³æ¯å–®ä½æ˜¯ 4 bytesï¼‰ã€‚
>- æ‰€ä»¥ `IHL = 2` è¡¨ç¤ºæ¨™é ­é•·åº¦ç‚º `2 Ã— 4 = 8 bytes`
>- ä½† **IPv4 çš„æœ€å°æ¨™é ­é•·åº¦å°±æ˜¯ 20 bytesï¼ˆå³ IHL = 5ï¼‰**
>- æ‰€ä»¥ IHL = 2 æ˜¯**éæ³•å€¼**ï¼Œè¡¨ç¤ºé€™å€‹å°åŒ…çš„æ ¼å¼æ˜¯éŒ¯èª¤çš„


### Redirection
- è·¯ç”±è¡¨æ˜¯å‹•æ…‹æ›´æ–°çš„ã€‚
- ç„¶è€Œï¼Œç‚ºäº†æé«˜æ•ˆç‡ï¼Œä¸»æ©Ÿä¸åƒèˆ‡è·¯ç”±æ›´æ–°éç¨‹ã€‚
	- ä¸»æ©Ÿæ•¸é‡éå¸¸å¤šã€‚(å¦‚æœä¸»æ©Ÿåƒé æ›´æ–°æœƒé€ æˆå¾ˆå¤§çš„ç¶²è·¯è² æ“”)
	- å› æ­¤ï¼Œä¸»æ©Ÿä½¿ç”¨éœæ…‹è·¯ç”±ã€‚
	- åªçŸ¥é“é è¨­è·¯ç”±å™¨çš„ IP ä½å€ã€‚
-  å› ç‚ºä¸»æ©Ÿ**åªçŸ¥é“é è¨­è·¯ç”±å™¨**ï¼Œè‹¥è¨­å®šéŒ¯èª¤æˆ–ç¶²è·¯æ‹“æ¨¸æœ‰è®ŠåŒ–
	- ä¸»æ©Ÿå°±å¯èƒ½æœƒ**æŠŠè³‡æ–™å°åŒ…é€éŒ¯è·¯ç”±å™¨**
	- é€™å¯èƒ½æœƒå°è‡´å°åŒ…ç„¡æ³•æŠµé”ç›®çš„åœ°ï¼Œæˆ–ç”¢ç”Ÿé¡å¤–çš„å»¶é²èˆ‡éŒ¯èª¤
- ä¸»æ©Ÿé€šå¸¸å¾ä¸€å¼µå°å‹è·¯ç”±è¡¨é–‹å§‹ï¼Œç„¶å¾Œé€æ¼¸æ“´å……å’Œæ›´æ–°ã€‚
	- å¯¦ç¾æ­¤ç›®çš„çš„å·¥å…·ä¹‹ä¸€æ˜¯é‡å®šå‘è¨Šæ¯ã€‚

> [!question]- Question: Error-reporting messagesçš„Data Sectionè¦å¸¶ä»€éº¼å‘¢?
> ç™¼ç”ŸéŒ¯èª¤æˆ–æ˜¯è¢«ä¸Ÿæ£„çš„å°åŒ…çš„è³‡è¨Š, è®“original sourceèƒ½çŸ¥é“å“ªä¸€å€‹å°åŒ…è¢«ä¸Ÿæ£„äº†
> åŸå§‹å°åŒ…çš„ IP æ¨™é ­ï¼ˆHeaderï¼‰ï¼‹å…¶å¾Œçš„å‰ 8 å€‹ bytes çš„è³‡æ–™ï¼ˆPayloadï¼‰
> é€šå¸¸ å‰ 8 bytes payload å°±æœ‰transport layer çš„æ‰€æœ‰è³‡æ–™ï¼ˆtcp udpï¼‰æœ‰åŠ©æ–¼åˆ¤æ–·error

- æ‰€æœ‰éŒ¯èª¤è¨Šæ¯ä¸­çš„è³‡æ–™éƒ¨åˆ†éƒ½åŒ…å«ä»¥ä¸‹å…§å®¹ï¼š
	- åŸå§‹è³‡æ–™å°åŒ…(packet)çš„ IP æ¨™é ­
	- é€™ä»½è³‡æ–™å ±çš„å‰ 8 å€‹è³‡æ–™ä½å…ƒçµ„
	- æä¾›æœ‰é—œé€£æ¥åŸ è™Ÿç¢¼ï¼ˆUDP å’Œ TCPï¼‰å’Œåºè™Ÿï¼ˆTCPï¼‰çš„ä¿¡æ¯
- ç„¶å¾Œï¼Œä¾†æºç«¯å¯ä»¥å°‡éŒ¯èª¤å‘ŠçŸ¥ä¸Šå±¤å”å®šï¼ˆTCP æˆ– UDPï¼‰

 ![[Pasted image 20250607155751.png]]
1. ç•¶æœ‰error ç™¼ç”Ÿ
2. åœ¨åŸæœ¬çš„ ip packet å‰ï¼Œæ¥ä¸Š ICMP header ç”¨ä»¥è¡¨é”éŒ¯èª¤è¨Šæ¯
3. åœ¨ icmp packet ä¸ŠåŠ ä¸Šï¼Œip header å¥½æ–¹ä¾¿ network å¯„é€ packet å› source host


## Query message
- é™¤äº†éŒ¯èª¤é€šå ±ï¼ˆError messagesï¼‰ä¹‹å¤–ï¼ŒICMP é‚„æœ‰ä¸€äº›ã€ŒæŸ¥è©¢å‹è¨Šæ¯ã€ï¼Œå¸¸ç”¨ä¾†æ¸¬è©¦èˆ‡è¨ºæ–·ç¶²è·¯é€£ç·šç‹€æ³ã€‚ 
	- Timestamp request and reply (skipped!)
	- Echo request and reply
### Echo Request and Reply

| è¨Šæ¯åç¨±              | Type | ç”¨é€”               | å¸¸è¦‹å·¥å…·   |
| ----------------- | ---- | ---------------- | ------ |
| Echo Request      | 8    | æ¸¬è©¦ä¸»æ©Ÿå¯é”           | `ping` |
| Echo Reply        | 0    | å›æ‡‰ ping          | `ping` |
![[Pasted image 20250607192132.png]]
# Debugging Tools





## Ping
ä½ é€™æ®µæè¿°çš„æ˜¯ã€Œ**ICMP Echo Request / Reply æ©Ÿåˆ¶**ã€ï¼Œé€šå¸¸å°±æ˜¯æˆ‘å€‘åœ¨é›»è…¦ä¸­ä½¿ç”¨çš„ `ping` æŒ‡ä»¤èƒŒå¾Œçš„åŸç†ã€‚ä»¥ä¸‹æˆ‘å¹«ä½ æ•´ç†æˆ**å°ç£ç”¨èªèˆ‡æµç¨‹é‡é»**ï¼Œæ–¹ä¾¿ä½ è¤‡ç¿’èˆ‡æ•™å­¸ç”¨ï¼š

---

## ğŸŸ¢ å¦‚ä½•åˆ¤æ–·ä¸€å°ä¸»æ©Ÿæ˜¯å¦ã€Œå­˜æ´»ä¸¦æœ‰å›æ‡‰ã€ï¼Ÿ

### æ“ä½œæµç¨‹ï¼ˆä»¥ `ping` ç‚ºä¾‹ï¼‰ï¼š

1. **ä¾†æºä¸»æ©Ÿ**ç™¼é€ä¸€å€‹ **ICMP Echo Request** å°åŒ…
    
    - Type: `8`
        
    - Code: `0`
        
    - åŠ å…¥ä¸€å€‹**åºåˆ—è™Ÿï¼ˆsequence numberï¼‰**ï¼Œé€šå¸¸å¾ 0 é–‹å§‹ï¼Œæ¯æ¬¡ç™¼é€åŠ  1
        
    - åœ¨è³‡æ–™å€å¡Šä¸­æ”¾å…¥ã€Œ**ç™¼é€æ™‚é–“æˆ³è¨˜**ã€
        
2. **ç›®çš„ä¸»æ©Ÿï¼ˆå¦‚æœåœ¨ç·šä¸Šï¼‰**æœƒå›å‚³ä¸€å€‹ **ICMP Echo Reply** å°åŒ…
    
    - Type: `0`
        
    - Code: `0`
        
3. **ä¾†æºä¸»æ©Ÿæ”¶åˆ°å›æ‡‰å¾Œ**ï¼š
    
    - ç”¨ã€Œç›®å‰æ™‚é–“ - ç™¼é€æ™‚é–“ã€è¨ˆç®— **RTTï¼ˆRound Trip Timeï¼Œä¾†å›æ™‚é–“ï¼‰**
        

---

### ğŸ•“ RTT è¨ˆç®—æ–¹å¼ï¼š

```text
RTT = åˆ°é”å›æ‡‰çš„æ™‚é–“é» - ç•¶åˆé€å‡º request çš„æ™‚é–“é»
```

é€™å¯ä»¥å¹«ä½ æ¸¬è©¦ï¼š

- ç›®æ¨™ä¸»æ©Ÿæ˜¯å¦åœ¨ç·šä¸Š
    
- å¾ä½ çš„ä½ç½®åˆ°å°æ–¹çš„ç¶²è·¯å»¶é²ï¼ˆä¾‹å¦‚ï¼šå»¶é² 20msï¼‰
    

---

### âœ… å°çµï¼š

|é …ç›®|å€¼|
|---|---|
|Request é¡å‹|ICMP Type 8, Code 0|
|Reply é¡å‹|ICMP Type 0, Code 0|
|æª¢æŸ¥å…§å®¹|ä¸»æ©Ÿæ˜¯å¦åœ¨ç·šä¸Šã€æœ‰ç„¡å°åŒ…éºå¤±ã€RTT|
|å·¥å…·|`ping` æŒ‡ä»¤|

---

å¦‚æœä½ æœ‰èˆˆè¶£ï¼Œæˆ‘å¯ä»¥å¹«ä½ ç”¨ Wireshark åˆ†æ `ping` å°åŒ…çš„å¯¦éš›å…§å®¹ï¼Œæˆ–ç”¨ç¨‹å¼ï¼ˆPython / Rustï¼‰æ¨¡æ“¬ç™¼é€ ICMP å°åŒ…ã€‚è¦è©¦è©¦çœ‹å—ï¼Ÿ






ä½ é€™æ®µæ˜¯åœ¨èªªæ˜ **`tracert`ï¼ˆWindowsï¼‰æˆ– `traceroute`ï¼ˆLinux/macOSï¼‰** çš„åŸç†ã€‚é€™å€‹å·¥å…·å¯ä»¥å¹«åŠ©æˆ‘å€‘ã€Œ**è¿½è¹¤å°åŒ…å¾ä¾†æºä¸€è·¯åˆ°ç›®çš„åœ°çš„è·¯å¾‘**ã€ã€‚ä»¥ä¸‹æ˜¯ç°¡æ˜çš„æµç¨‹èˆ‡å°ç£ç”¨èªèªªæ˜ï¼š

---

## ğŸ“ `tracert`/`traceroute` çš„åŸç†èˆ‡æµç¨‹

é€™å€‹å·¥å…·å…¶å¯¦æ˜¯**ç”¨æ‡‰ç”¨ç¨‹å¼æ¨¡æ“¬ UDP å°åŒ…**ï¼Œå†**é  ICMP éŒ¯èª¤è¨Šæ¯ä¾†åˆ¤æ–·æ¯ä¸€è·³ï¼ˆrouterï¼‰çš„ä½ç½®**ã€‚

---

### ğŸ§ª æ“ä½œæµç¨‹ï¼š

1. `tracert` å‚³é€ä¸€å€‹ UDP å°åŒ…ï¼ˆç›®æ¨™æ˜¯ç›®çš„åœ°ï¼Œä½†è¨­å®šä¸€å€‹éå¸¸å°çš„ TTL å€¼ï¼‰
    
    - ä¾‹å¦‚ï¼šTTL = 1
        
2. ç¬¬ä¸€å°è·¯ç”±å™¨æ”¶åˆ°å°åŒ…æ™‚ TTL æ¸›ä¸€ â†’ TTL = 0  
    â†’ ä¸Ÿæ£„å°åŒ…ä¸¦é€å› **ICMP Time Exceededï¼ˆtype 11ï¼‰**
    
3. `tracert` æ”¶åˆ°é€™å€‹ ICMP å›æ‡‰ â†’ ç´€éŒ„ã€Œç¬¬ä¸€è·³ IPã€èˆ‡æ™‚é–“
    
4. æ¥è‘— `tracert` å‚³ TTL=2 çš„å°åŒ… â†’ åˆ°ç¬¬äºŒè·³ routerï¼ŒåŒæ¨£æœƒæ”¶åˆ° ICMP time exceeded
    
5. ç›´åˆ°å°åŒ…æˆåŠŸåˆ°é”ç›®çš„ä¸»æ©Ÿï¼Œä½†ä¸»æ©Ÿæœƒä¸Ÿæ£„é€™å€‹å¥‡æ€ªçš„ UDP å°åŒ…ï¼ˆé€šå¸¸ç™¼é€åˆ°ä¸å­˜åœ¨çš„ portï¼‰  
    â†’ å›å‚³ **ICMP Destination Unreachableï¼ˆtype 3, code 3ï¼‰**
    

---

### ğŸ’¡ ç”¨åˆ°çš„å…©ç¨® ICMPï¼š

|é¡å‹|ç”¨é€”|
|---|---|
|ICMP Time Exceeded (type 11)|ä¸­ç¹¼è·¯ç”±å™¨ TTL ç‚º 0 æ™‚ç™¼é€ï¼Œç”¨ä¾†å¾—çŸ¥è·¯å¾‘ä¸­çš„æ¯ä¸€è·³|
|ICMP Destination Unreachable (type 3)|ç›®çš„åœ°ä¸»æ©Ÿæ”¶åˆ°ç„¡æ•ˆ UDP å°åŒ…æ™‚å›æ‡‰ï¼Œè¡¨ç¤ºè·¯å¾‘å·²çµæŸ|

---

### ğŸ§­ ç¯„ä¾‹ï¼š

```bash
C:\> tracert www.google.com
```

å¯èƒ½çœ‹åˆ°ï¼š

```text
1   <1ms   192.168.1.1
2   10ms   140.113.1.1
3   25ms   203.78.xxx.xxx
...
10  50ms   142.251.xx.xx â† Google ä¼ºæœå™¨
```

---

### âœ… å°çµï¼š

|åŠŸèƒ½|èªªæ˜|
|---|---|
|å·¥å…·åç¨±|`tracert`ï¼ˆWindowsï¼‰ã€`traceroute`ï¼ˆLinuxï¼‰|
|å‚³é€æ–¹å¼|æ¨¡æ“¬ UDP å°åŒ…|
|ä¾é å›æ‡‰|ICMP Time Exceededã€Destination Unreachable|
|ä½œç”¨|æ‰¾å‡ºã€Œå°åŒ…è·¯å¾‘ã€èˆ‡ã€Œæ¯ä¸€è·³å»¶é²ã€|

---

å¦‚æœä½ æƒ³çœ‹å¯¦éš›å°åŒ…ï¼Œæˆ‘å¯ä»¥æ•™ä½ æ€éº¼ç”¨ Wireshark æŠ“å‡º `tracert` çš„éç¨‹ï¼Œè¦è©¦è©¦å—ï¼Ÿ






