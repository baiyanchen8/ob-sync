# Mass Storage Structure
## Intro
巨量儲存 HHD or nonvolatile Memory

## Disk interface
![[Pasted image 20240926183930.png]]
1. **Disk Interface**：對作業系統來說，硬碟的抽象呈現方式。
2. **Abstraction**：硬碟或固態硬碟在作業系統中是以「邏輯區塊」（logical blocks）的陣列來表現。
   - 邏輯區塊（logic block）是最小的傳輸單位。
3. **I/O Requests**：作業系統透過「邏輯區塊號碼」（LBN）或「邏輯區塊位址」（LBA）來發出輸入/輸出請求。
4. **HDD vs. SSD**：實際上，HDD 是由「磁區」（sectors）組成，而 SSD 則是由「頁面」（pages）組成。這部分會在後面介紹。
![[Pasted image 20240926184127.png]]
## Hard Disk Driver (使用磁性作為紀錄)

###  Hard Disk Structure
![[Pasted image 20240926183315.png]]
![[Pasted image 20240926184956.png]]
1. **磁區（Sector）**：  
   - 硬碟上的數據儲存單位。每個磁區通常大小為512字節或4096字節（現代硬碟多為後者，稱為"高級格式"）。  
   - 硬碟將資料分成小塊，每一個小塊稱為一個磁區。資料存取時，會以磁區為單位進行讀寫。
2. **磁軌（Track）**：  
   - 磁碟表面上，磁頭在每一個圓盤上掃過的同心圓路徑稱為磁軌。  
   - 每一個盤片面都分為多個磁軌，類似唱片上的軌道。
3. **磁柱（Cylinder）**：  
   - 當硬碟的每個盤片面都被劃分成多個磁軌時，垂直對應的不同盤片上相同編號的磁軌組合在一起就形成了磁柱。  
   - 換句話說，磁柱是所有盤片上位於同一位置的磁軌集合。當磁頭在一個磁柱的位置時，不需要進行磁頭移動，就可以讀取不同盤片上的相應數據，因此讀取效率較高。

> [!question] Why we  care Cylinder?
> 因為可以同時讀取同一個 Cylinder 的同一個 Sector(因為 disk arm 結構問題)

### A Simple  Disk Drive

1. **旋轉延遲（Rotation Delay/latency）**：
   - 又稱為**旋轉延遲時間**或**旋轉等待時間**。
   - 是指硬碟磁片旋轉至磁頭能夠到**達目標磁區的等待時間**。
   - 硬碟盤片以固定的轉速旋轉，通常以每分鐘轉速（RPM）來表示，旋轉延遲是因為磁頭需要等待盤片旋轉到正確的位置，平均值大約是整圈旋轉時間的一半。

2. **傳輸時間（Transfer Time）**：
   - 是指硬碟在找到目標數據後，**將數據從磁碟讀取出來或寫入的時間。**
   - 這時間取決於磁區的大小以及硬碟的讀取速度。
   - 一旦磁頭定位到正確位置，傳輸時間相對來說是最快的階段。

3. **尋道時間（Seek Time）**：
   - 尋道時間是指磁頭從當前位置移動到需要讀取或寫入的目標磁軌（track）所花費的時間。
   - the time from track to track
   - 磁頭需要上下移動來對應不同的磁軌，因此尋道時間主要取決於磁頭移動的速度。平均尋道時間是多次移動操作的平均值。
access time =Rotation Delay + Transfer Time + Seek time
### 測試方法 -- Random workload(隨機存儲時間)
字面意義
> [!方法]
> 使用 small size 做單次連續存取，即可算出平均**Throughput**

![[Pasted image 20240926191722.png]]

**Cheetah 15K.5硬碟性能**（高性能SCSI硬碟）的 random workload in 4kb：
- **T_seek = 4ms**：尋道時間為4毫秒。
- **T_rotation = 2ms**
	-  計算公式：$\frac{R}{2}$（平均時間） ,R 為一圈的時間
	- $R=60/15000=4(ms)$
- **T_transfer = 32微秒**：傳輸時間為32微秒($\frac{4(KB)}{125(MB/sec)}$)（數據傳輸速率為125MB/秒，讀取4KB數據的時間）。
- **T_I/O ≈ 6ms**
   - **Throughput = 0.66 MB/s**：I/O操作的吞吐量，等於4KB數據/6毫秒，結果為0.66 MB/s。
### 測試方法 -- Sequential workload(連續存儲時間)
**for 100 MB**
![[Pasted image 20240926192943.png]]

### 補充 SCSI & SATA
![[Pasted image 20240926192528.png]]
這張圖展示了**儲存介面（Storage Interfaces）**的演進過程，分別介紹了兩條主要技術路線：從**IDE到SATA**，以及從**SCSI到SAS**。以下是這些技術的簡單解釋：
1. **IDE（Integrated Drive Electronics）**
   - **IDE** 是早期的硬碟介面標準，它將硬碟控制器整合在硬碟本身上。這是一個並行數據傳輸技術，數據通過多條數據線同時傳輸。
   - **ATA（Advanced Technology Attachment）** 是IDE的改良版，允許硬碟和其他儲存設備以更高效的方式連接到主機。
2. **SATA（Serial ATA）**
   - **SATA** 是IDE/ATA的後繼者，使用序列數據傳輸技術（Serial Communication），這使數據傳輸更加穩定且速度更快。SATA介面用更少的線纜來達成更高的傳輸效率，也解決了舊有IDE並行傳輸的干擾問題。
   - **eSATA（External SATA）** 是SATA的外部版本，用來連接外部硬碟，保持高速數據傳輸而無需使用USB或其他傳輸技術。
3. **SCSI（Small Computer System Interface）**
   - **SCSI** 是另一個常見的硬碟接口標準，主要應用於伺服器和高性能工作站中。它是一種並行介面，允許多個設備同時連接到一個總線上。
   - **SAS（Serial Attached SCSI）** 是SCSI的序列版本，與SATA類似，採用了序列數據傳輸技術。SAS相較於傳統SCSI有更高的速度和靈活性，適合高要求的企業級儲存設備。
4. **圖中展示**
   - 圖中顯示了各種接口，例如eSATA、USB等，這些接口常見於現代儲存設備上，用來連接內部和外部的儲存裝置。
**總結**：
- **IDE → SATA → eSATA** 展現了桌面和消費級儲存技術的演進，從並行傳輸到序列傳輸，並增加了外部設備的連接能力。
- **SCSI → SAS** 展現了企業級和伺服器硬碟技術的進化，從並行SCSI到更現代化的SAS，提升了性能和擴展性。
## Nonvolatile Memory Devices
### Overview 
- **NVM設備的特徵**：與機械設備相比，NVM是「電子」設備。
- **可能的解決方案**：
    - **NAND快閃記憶體半導體晶片**：最常被採用。
    - DRAM搭配電池備份。
- example:
	-  **固態硬碟**（SSD）
	- USB隨身碟（thumb drive, flash drive）
	- 晶片直接安裝在主機板上，作為像智慧型手機等設備的主要儲存裝置。

![[Pasted image 20240926194731.png]]
- **快閃記憶體晶片**包含許多**區塊**（blocks）。
- 一個區塊由許多**頁面**（pages）組成，通常有64到256個頁面，頁面大小為2KB到4KB不等。
- **快閃記憶體**支援三種操作：讀取（read）、寫入（write）和抹除（erase）。
	- 速度 : (快) read > write > erase (慢)
	- earse : 一次只能 earse 一整個 block 
	- \![[Pasted image 20240928132638.png]]
- 讀取與寫入是以「**頁面**」為單位進行的，但無法就地覆寫。
- 如果要覆寫，必須先抹除，而抹除是以「**區塊**」為單位進行的。
- 一個區塊(block)的抹除(earse)次數是有限的，約在10萬次左右，之後區塊會磨損失效。
### Good & Bad
#### ***優點 (Good)***
1. **更可靠 (可靠性較高)**：由於 NAND Flash 沒有像傳統硬碟 (HDD) 那樣的機械運動零件，因此在衝擊、震動等情況下，資料丟失的風險較低，故障率也較低。
2. **速度更快**：由於沒有硬碟的「尋道時間」和「旋轉延遲」問題，NAND Flash 的讀寫速度遠快於傳統 HDD，尤其在隨機讀寫上表現尤為明顯。
3. **耗電量較低**：SSD 和其他 NAND Flash 設備的功耗比 HDD 更低，非常適合用在筆記型電腦或行動裝置上。
4. **重量輕**：由於沒有磁碟和馬達等機械組件，因此 NAND Flash 相關產品重量更輕。
5. **體積小**：NAND Flash 可以做得非常小，適合嵌入各種設備中，比如手機、平板電腦和隨身碟。
6. **抗震能力強**：由於沒有移動零件，NAND Flash 在遭受震動或物理衝擊時，能夠保持穩定工作，適合便攜式設備。
#### ***缺點 (Bad)***
1. **每 MB 成本較高**：相比 HDD，NAND Flash 記憶體的每 MB 價格要高得多，雖然這些年成本有所下降，但大容量 SSD 還是比傳統硬碟昂貴。
2. **容量較小**：NAND Flash 雖然有進步，但相比於 HDD，尤其是大容量的需求（如伺服器或備份用途），目前仍然偏小。
3. **壽命可能較短**：NAND Flash 記憶體的單元在經過一定次數的寫入和擦除循環後會逐漸失效，這就是所謂的「磨損」。雖然現代的技術有壽命延長的措施（如 Wear Leveling 技術），但相比於 HDD，它的壽命還是有限。
### firmware (嵌入式系統)
![[Pasted image 20240928132901.png]]
### Overwrite
- In-place update: erase and then (over-)write: 
	-  Bad. Why? 
	- 因為在 Nonvolatile Memory Devices 中,earse 會 earse 整個 block,會浪費時間
- Out-of-place update: write to another free page: 
	- Adopted
#### in-place update
```image-layout
---
layout: carousel
carouselShowThumbnails: true
---
![[Pasted image 20240928134837.png]]
![[Pasted image 20240928135105.png]]
![[Pasted image 20240928135210.png]]
![[Pasted image 20240928135313.png]]
![[Pasted image 20240928135359.png]]
![[Pasted image 20240928135507.png]]
```
#### out-place update
```image-layout
---
layout: carousel
carouselShowThumbnails: true
---
![[Pasted image 20240928135703.png]]
![[Pasted image 20240928135807.png]]
```
##### ***注意***
要重新做 **MAPPING**
### MAPPING  for SSD
> [!bug] 提供給 HDD 的 file system 是 for  in-place update ,但 SSD 並不是用這個
> - HDD
> 	-  in-place update
> - SSD
> 	- out-place update
> 	- 使用 FTL (flash Translate Layer)
> 		- 在 frimware(SSD) 實踐 把 out-place update 偽裝 in-place update
> 		- perform address mapping
> 			- logical block number → physical page number


![[Pasted image 20240928140750.png]]

![[Pasted image 20240928140712.png]]
### Fix free place (處理由於 out-of-place update 產生的問題)
1. **GC（Garbage Collection, 垃圾回收,FTL處理）**
   - 處理無效頁面，釋放存儲空間。
   - 將有效數據移至新位置，並擦除無效區塊。
   - 可能影響效能，並加速磨損。
	\![[Pasted image 20240928141448.png]]
	- over provisioning space
		- **超額配置**是指在 SSD 中劃分出一部分的存儲空間，這部分空間不會對使用者可見或可用。這個空間專門用來提升 SSD 的效能和壽命。
		- 用於避免沒有空間可用於 GC

2. **Wear-leveling（磨損均衡）**
   - 均衡 SSD 各區塊的擦寫次數，延長壽命。
   - **動態磨損均衡**：頻繁區塊與少用區塊交換數據。
   - **靜態磨損均衡**：即使不常用的區塊也參與磨損均衡。

3. **DWPD（Drive Writes Per Day, 日均寫入量）**
   - 衡量 SSD 每天可寫入的次數。
   - 舉例：DWPD 3 表示 SSD 每天可寫入相當於硬碟總容量 3 倍的數據。
   - 公式：\[ \text{DWPD} = \frac{\text{TBW}}{\text{SSD 容量} \times \text{保證年限（日數）}} \]
## volatile Memory
![[Pasted image 20240928142018.png]]
## Secondary Storage Connection Methods
![[Pasted image 20240928142202.png]]
在電腦架構中，**北橋（Northbridge)** 和 **南橋（Southbridge)** 是兩個重要的晶片組（chipset）組成部分，主要用於管理和協調主機板上的各種功能。

### 北橋（Northbridge）(System bus)
- **功能**：負責處理高速的數據傳輸，包括中央處理器（CPU）、隨機存取記憶體（RAM）、顯示卡（GPU）等之間的通訊。
- **連接**：通常與CPU和RAM直接相連，提供更快的數據通道。它還可能連接到南橋，以進一步處理其他周邊設備的通訊。
	- ex: CPU,RAM,PCIE(M.2,NVMe)

### 南橋（Southbridge）(I/O bus)
- **功能**：負責較慢的設備和外部連接的管理，例如硬碟、USB裝置、網路卡、聲卡等。
- **連接**：南橋與北橋相連，處理所有來自北橋的較慢數據傳輸需求。它還包括了I/O（輸入/輸出）控制器，用於管理周邊設備。
	- ex: SATA,PCI...

![[Pasted image 20240928142652.png]]
### 總結
簡而言之，北橋負責處理高速通訊，而南橋則處理較慢的周邊設備通訊。這兩者的協作確保了整個系統的流暢運作。在現代的電腦設計中，這兩個功能有時會合併到單一晶片中，或者直接集成到CPU內部。

## Address Mapping

# HDD Scheduling
# NVM Scheduling
# Error Detection and Correction
# Swap-Spacw Manage
# RAID
# Object Storage



